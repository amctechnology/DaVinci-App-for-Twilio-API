# Setup

This file contains the setup information for the [Twilio](https://www.twilio.com/console) App for DaVinci.

> Contact AMC Support for help with setup if this file is not sufficient.

## Scripts

Before you run the script you will need the following information.

- [AccountSid](https://www.twilio.com/console)
- [AuthToken](https://www.twilio.com/console)
- Callback URL
  - Found when you create a new function in Twilio. It is the part of the Path that is already filled in when you create the function.
- Three Twilio Phone Numbers
  - One for taking calls and messages.
  - Two for the Proxy, these two numbers should not be assigned to a prexisting proxy. If they are already assigned to a proxy the script will fail and they will not be added to the one generated by the script.

Run `npm install twilio` and `npm install readline-sync` to install the packages needed for the script.
Run `node setup` to setup part of your Twilio Environment. Follow the instructions in the CLI and it will setup the TaskRouter, Chat, and the Proxy.

### General Setup

The first two things you will need from Twilio are your `AccountSid` and your `AuthToken`. These function like your username and password. They can be found at the [Twilio Project Home](https://www.twilio.com/console) or under the [settings](https://www.twilio.com/console/project/settings) tab.

### TaskRouter

The `Workspace` for the DaVinci App for Twilio are completely setup by the script.
The script will create a fully functioning TaskRouter call `generated-workspace` that will have `ACW` added as a task and it will set up the `Event Callback URL` so that is points to the `taskRouterWebhook` function.

### Functions

> Note: All of your functions will share the same base callback url. This is needed later.

#### You will need to make the following 9 functions and copy over their text from the corresponding files in the setup folder inside the ClientApp folder.

The Twilio Path will be appended to your callback url in each function. This is how the functions are referenced by each other.

1. outboundMessage
   - Filename: `outboundMessage.js`
   - Twilio Path: `/outboundMessage`
2. Cleanup
   - Filename: `Cleanup.js`
   - Twilio Path: `/cleanup`
3. playRingtone
   - Filename: `playRingtone.js`
   - Twilio Path: `/playRingtone`
4. taskRouterWebhook
   - Filename: `taskRouterWebhook.js`
   - Twilio Path: `/taskRouterWebhook`
5. updateConferenceParticipants
   - Filename: `updateConference.js`
   - Twilio Path: `/updateConferenceParticipants`
6. outbound
   - Filename: `outbound.js`
   - Twilio Path: `/outbound`
7. InboundSMS
   - Filename: `inboundSMS.js`
   - Twilio Path: `/InboundSMS`
8. Twilio Client Quickstart (Capability Token)
   - Filename: `TwilioClientQuickStartCapabilityToken.js`
   - Twilio Path: `/capability-token`
9. Twilio Client Quickstart (Voice Calls)
   - Filename: `TwilioClientQuickStartVoiceCalls.js`
   - Twilio Path: `/client-voice`

#### You will need to make the following 8 envirnomental variables [here](https://www.twilio.com/console/functions/configure). These variables are used by the functions and are unique to the enviroment being setup.

1. `CALLER_ID`
   - This is the third phone number and is not used by the proxy. This phone number is your outward facing number that is taking calls.
2. `CHAT_SERVICE`
   - This is the sid for the chat found [here](https://www.twilio.com/console/chat/dashboard).
3. `OUTBOUND_FROM`
   - This is the phone number you want to appear when making outbound calls and messages, this is the same as `CALLER_ID` for now.
4. `PROXY_SERVICE`
   - This is the sid for the proxy found [here](https://www.twilio.com/console/proxy)
5. `TWIML_APP_SID`
   - This is the sid for the TwiML found [here](https://www.twilio.com/console/voice/twiml/apps)
6. `URL`
   - This is the callback URL found in your functions.
7. `WORKFLOW`
   - This is the sid for the workflow found [inside your workspace](https://www.twilio.com/console/taskrouter/dashboard).
8. `WORKSPACE`
   - This is the sid for workspace found [here](https://www.twilio.com/console/taskrouter/dashboard).

#### You will need the following Dependencies located below the environmental variables. These are `Node.js` packages that need to be installed in order for your functions to run.

1. `xmldom`
   - version: 0.1.27
2. `lodash`
   - version: 4.17.4
3. `fs`
   - version: 0.0.1-security
4. `util`
   - version: 0.10.3
5. `twilio`
   - version: 3.33.0

### Chat

The script will create the chat and name it `generate-chat`.

After you run the setup script you will have to go into the `generated-chat` [here](https://www.twilio.com/console/chat/dashboard) and then under webhooks you will need to add your `callback url + /outboundMessage` to the callback url and then check `OnMessageSent` in the callback events section.

### Proxy

Before you setup the proxy you need `two twilio phone numbers` and their `sids` as well as the `chat's sid`. Once you have those you can run `npm run setup` and it will setup the proxy with the two phone numbers.

### Studio

In the [studio](https://www.twilio.com/console/studio/dashboard) tab in Twilio you can add Flows to your account. From here you will create two flows. One for `sms` and one for `phone`.

Inside the `sms` flow you will create a `function` that is connected to the `Incoming Message` on the `Trigger`. This function's `Function URL` should be `InboundSMS`, one of the functions created earlier.

Next go into the `phone` flow and create an `Enqueue Call`. Attach this to the `Incoming Call` on the `Trigger`. Then in the `Enqueue Call` set the `Queue or TaskRouter Task` to `TaskRouterTask`. Then change the `Task Router Workspace` to `generated-workspace`, or the name of your prexisting workspace, and change the `Task Router Workflow` to `Default Fifo Workflow`. Next under `Task Attributes JSON` type `{"type": "phone"}` this.

### Phone Numbers

Here you will need to purchase three or more phone numbers [here](https://www.twilio.com/console/phone-numbers/incoming).

- Two of the phone numbers will need to be configured for the proxy.
  - In the `A Call Comes In` field select `Proxy Service` and then select `generated-proxy` or the name of your proxy.
  - In the `A Message Comes In` field select `Proxy Service` and then select `generated-proxy` or the name of your proxy.
- The Third number will be your outbound facing number that recieves calls and messages
  - In the `A Call Comes In` field select `Studio Flow` and then select `phone` or the name of your proxy.
  - In the `A Message Comes In` field select `Studio Flow` and then select `sms` or the name of your proxy.

Finally under [Programmable Voice](https://www.twilio.com/console/voice/conferences/settings) make sure that you have enabled Agent Conference.

### TwiML

In the [TwiML Apps](https://www.twilio.com/console/voice/twiml/apps) under TwiML in the Programmable Voice section of Twilio create a new TwiML app. Inside the TwiML app you created set the `Request URL` under Voice to the `callback url + /outbound`.

### Assets

In the [Assets](https://www.twilio.com/console/assets/public) upload the files from the assets folder.

---

## Creators Studio

### You will need the following pieces of information from Twilio:

1. [AccountSid](https://www.twilio.com/console)
2. [AuthToken](https://www.twilio.com/console)
3. [WorkspaceSid](https://www.twilio.com/console/taskrouter/workspaces)
4. DirectWorkFlowSid

   - This is located inside the [Workspace](https://www.twilio.com/console/taskrouter/workspaces) under the workflow tab.

5. [ChatServiceSid](https://www.twilio.com/console/chat/dashboard)
6. [ChatApiSid](https://www.twilio.com/console/chat/project/api-keys)
7. ChatApiSecret
   - This is created when you create a new Chat API [here](https://www.twilio.com/console/phone-numbers/project/api-keys) and only appears when you create the new ChatAPI. So you must copy it and save it somewhere so you don't lose it.
8. [VoiceApplicationSid](https://www.twilio.com/console/voice/twiml/apps)

Plug these values into their respective fields under the config tab for the `Twlio Api App`.

[Setup](https://amcdavincistorage.blob.core.windows.net/amc-external-files/TwilioSetup.zip)
